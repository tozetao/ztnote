## nginx与php的编译
apache是把php当作自己的一个模块来启动运行的，而nginx则是把http请求变量（如get、user_agent等）转发给php进程，nginx是与php独立进程进行通信的，称为fastcgi运行方式。

所以一般apache所编译的php，是不能用于nginx的。

apache是将php当成模块加载在内部来进行处理的，nginx和php的关系是平等的，php是一个独立的进程运行着，nginx收到请求后发现你是想运行php，就将请求的信息发送给php，php处理完毕后再返回给nginx，nginx在进行响应。

所以在nginx中要做一起转发，将内容转发给php进程。

### 1. php编译
php的编译要有如下功能模块，mysql的连接、gd库、ttf等模块。

查找编译相关帮助
```
cd php-5.4.19
# 进入php安装包目录

./configure -help | grep mysql
./configure -help | grep php-fpm
# 查找关于mysql编译配置的相关帮助
```
./configure配置编译
```
./configure \
--prefix=/usr/local/php \
--with-config-file-path=/usr/local/php/etc \
--enable-fpm \
--with-fpm-user=php-fpm \
--with-fpm-group=php-fpm \
--with-mysql=mysqlnd \                  //这里mysqlnd 是内部查找命令
--with-mysql-sock=/tmp/mysql.sock \
--with-libxml-dir \
--with-gd \
--with-jpeg-dir \
--with-png-dir \
--with-freetype-dir \
--with-iconv-dir \
--with-zlib-dir \
--with-mcrypt \
--enable-soap \
--enable-gd-native-ttf \
--enable-mbstring \
--enable-exif \
--disable-ipv6 \
--with-pear \
--with-curl \
--with-openssl \
--enable-gd-native-ttf \
--enable-gd-jis-conv

# 安装mcrypt
wget http://softlayer.dl.sourceforge.net/sourceforge/mcrypt/libmcrypt-2.5.8.tar.gz
tar -zxvf libmcrypt-2.5.8.tar.gz
cd /usr/local/src/libmcrypt-2.5.8
./configure --prefix=/usr/local
make
make install

# 我自己的编译配置
./configure \
--prefix=/usr/local/fastcgi_php \
--enable-fpm \
--with-fpm-user=php_fpm \
--with-fpm-group=php_fpm \
--with-mysql=mysqlnd \
--with-libxml-dir \
--with-gd \
--with-jpeg-dir \
--with-png-dir \
--with-freetype-dir \
--with-iconv-dir \
--with-zlib-dir \
--with-mcrypt=/usr/local/libmcrypt \
--enable-soap \
--enable-mbstring \
--enable-exif \
--disable-ipv6 \
--with-pear \
--with-curl \
--with-openssl \
--enable-gd-native-ttf \
--enable-gd-jis-conv

--with-config-file-path=/usr/local/fastcgi_php/etc \

## 支持apache的编译配置
./configure \
--prefix=/usr/local/apache_php5.5 \
--with-apxs2=/usr/local/httpd-2.4.25/bin/apxs \
--with-mysql=mysqlnd \
--with-libxml-dir \
--with-gd \
--with-jpeg-dir \
--with-png-dir \
--with-freetype-dir \
--with-iconv-dir \
--with-zlib-dir \
--with-mcrypt=/usr/local/libmcrypt \
--enable-soap \
--enable-mbstring \
--enable-exif \
--disable-ipv6 \
--with-pear \
--with-curl \
--with-openssl \
--enable-gd-native-ttf \
--enable-gd-jis-conv
```

启动FastCGI
```
在安装完毕后会有如下目录：
- bin，可执行文件
- etc，fastcgi php的配置文件目录
- include
- lib
- php
- sbin，包含fastcig php进程控制器
- var，一些日志文件

# php-fpm文件，该文件时php进程管理器，位于php安装目录下的sbin目录

# 拷贝php.ini配置文件到fpm php的lib目录下
cp /root/php5.6/php.ini-devlop... ./lib/php.ini

# 拷贝php-fpm.conf文件
cp etc/php-fpm.conf.default etc/php-fpm.conf

# 启动php-fpm
# ./sbin/php-fpm

# ps aux | grep php
```

```
# 一些安装提示
You may want to add: /usr/local/fastcgi_php/lib/php to your php.ini include_path
/root/php-5.6.30/build/shtool install -c ext/phar/phar.phar /usr/local/fastcgi_php/bin
ln -s -f phar.phar /usr/local/fastcgi_php/bin/phar
Installing PDO headers:           /usr/local/fastcgi_php/include/php/ext/pdo/
```

### 2. nginx配置php
将php重新编译完毕后，需要对nginx进行配置，让所有.php请求转发给php进程处理。
```
location ~ \.php$ {
	root html;
	fastcgi_pass 127.0.0.1:9000;
	# 请求要转发的端口
	fastcgi_index index.php;

	fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
	# php进程要加载的脚本文件 

	include fastcgi_params;
}
```

## apache、php编译安装
将apache安装完毕后，你需要将php作为apache的一个模块来进行编译。

apache与php的编译
```
./configure prefix=/usr/local/httpd
# 编译配置文件，缺少依赖文件则安装相关依赖包

./configure prefix=/usr/local/php \
--with-apxs2=/usr/local/httpd/bin/apxs
# php编译配置

# 最后分别进行安装即可

./configure --help |grep 软件包名
# 能查看相关依赖帮助

build share apache2.0 handler module，file is the options
# 该选项的文件时构建apache的模块
```

apache配置文件的修改
```
/AddType

AddType application/x-httpd-php	.php
```


## 源码安装命令说明

### 1. configure配置编译参数说明
with参数，./configure --with...
```
with：用于指定依赖关系
--with-依赖包名称=依赖包目录

example：
--with-apxs，指定apache的配置程序目录。
--with-gd，指静态编译gd库

--with-png-dir，指定libpng的路径
--with-libxml-dir，指向libxml库路径

一般带-dir是指向库目录，没有的话则是启用某些特性或者指向某指定路径。
```





最小centos需要安装的类库

openssl openssl-server

wget

vim

gcc gcc-c++
make
pcre pcre-devel
zlib
  