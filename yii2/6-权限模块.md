## Yii认证
yii2自带用户认证模块，先配置用户组件yii\web\User，指定一个含有实际认证逻辑的认证类，该认证类实现yii\web\IdentityInterface接口。

### yii\web\Userz，用户组件
该类用于管理用户的认证状态，可以通过Yii::$app->user来访问，有如下属性和方法：
- $identity = Yii::$app->user->identity，检测当前用户身份
- $id = Yii::$app->user->id，当前用户的id，为认证用户为null
- $isGuest = Yii::$app->user->isGuest，判断当前用户是否游客
- Yii::$app->user->login($identity)，记录用户登录状态，可以是cookie或session
- Yii::$app->user->logout()，注销用户

该用户组件在config目录下的main.php文件中做配置，一般会指定一个含有实际认证逻辑的认证类。

main.php config
```php
user => [],
'session' => [
	'name' => 'PHPBACKSESSION',
	'savePath' => sys_get_temp_dir()
]
'request' => [
	'cookieValidationKey' => 'sdfsdfsdf',
	'csrfParam' => '_adminCSRF'
]
```

### IdentityInterface
定义了认证模块需要实现的认证接口，根据这些接口我们就能实现应用的认证细节，一般会使用用户模型来实现该接口。

- findIdentity()
- findIdentityByAccessToken()
- getId()
- getAuthKey()
- validateAuthKey() 


## ACF授权
ACF是存取控制过滤器，通过yii\filters\AccessControl类来实现的简单授权方法，是一种简单的存取控制应用。

### 实现
在控制器中的behaviors方法中设定存取的规则，当用户请求一个动作的时候，会检查存取规则，判断用户是否被允许执行该动作。

```php
public function behaviors(){
	return [
		'access' => [
			'rules' => [
				['actions' => ['login', 'error'], 'allow' => true, 'roles' => [?]]
			]
		]
	];
}
```
actions是控制器的动作，allow表示是否允许执行，roles表示角色，在yii中?表示未认证用户，即游客，@表示已认证用户，即已经登陆的用户。

上述的规则表示游客在访问login、error动作时，会检查用户是否游客角色，是的话才允许执行。

### 其他存储规则
上述的存储规则是基于控制器动作的，在yii中还支持以下存取规则：
- ips：浏览器的ip地址，可以使用通配符*，为空则匹配所有ip
- verbs：匹配请求方式
- matchCallback，php匹配
- denyCallback，php回调，当规则禁止访问的时候会被调用


## RBAC
RBAC是基于角色的存取控制，表设计：
- menu：权限表，菜单表，存储整个系统的菜单，这些菜单其实就是权限
- role：角色表，角色是权限的集合，


### 1. 角色和权限的树结构
- 角色和权限都实现了树的层次结构
- 一个角色可能由其他角色或权限构成
- 权限也可以由其他权限构成

### 2. 权限检查
- 一个角色可以授予给一个或多个用户，
- 系统会检查用户所属角色是否拥有某个权限操作

### 3. 规则
RBAC还支持依据规则来授权，
- 规则可以是一段代码，用来与一个角色或者权限关联
- 通过规则的执行，检查一个用户是否满足角色或者权限的要求。


### 4. 实现步骤
### 建立授权数据
1. 配置应用组件DbManager，yii\rbac\DbManager，它使用4张表来建立rbac模型。
2. yii migrate --migrationPath=@yii/rbac/migrations，执行迁移命令创建数据库表。
3. 创建控制台控制器，填充授权数据，执行控制台控制器yii rbac/initte


### 执行权限检查
Yii::app->user->can();
对当前方法进行检查，是一种快捷的调用方式。

yii\rbac\ManagerInterface::checkAccess()
对任何用户进行权限检查。
