## 事务

事务，保证多个操作的原子性，一组操作要么全部执行成功，如果有某个操作执行失败的话，那么所有操作都会执行失败。

redis的事务需要使用multi命令和exec命令，在这俩个命令包围中的所有命令会一个一个执行，直到所有命令执行完毕后才会执行其他客户端的命令。







分析：

redis从客户端接收到multi命令时，会将该客户端发送的所有命令加入到队列中，直到客户端发送exec命令为止。然后redis会在不被其他客户端打断的情况下，有序的执行队列中的命令。



缺陷：

redis的事务是以multi命令开始的，在不执行exec命令时是不会执行事务中的任何命令的，所以用户没办法根据读取到的数据来做决定。



### multi

开始一个事务，使用multi命令后，redis会将事务中的命令存储到队列中，等待exec命令的执行。



### exec

结束一个事务，exec命令会将事务中存储在队列中命令取出来一一执行。



### watch

监视一个键，在执行exec命令之前的这段时间内。如果所监视的键被执行更新、删除或替换等操作，那么当用户执行exec命令时，事务将失败并返回一个错误。



### unwatch



### discard

discard可以在watch命令执行之后，multi命令执行之前对连接进行重置（reset）；也可以在multi命令执行之后，exec命令执行之前对连接进行重置。

这意味着用户在使用watch监视一个或多个键，接着使用multi命令开始一个新的事物，并将多个命令加入到事务队列后，仍然可以通过discard命令来取消watch命令并清空所有已入队命令。



### 非事务型流水线

pipeline()

这是python的方法，所谓的非事务流水线指的是在将多个redis命令收集起来，然后一次性发送给redis服务端处理。

在python可以使用pipeline()方法来处理。

性能方面的章节可以查看第四章。