## MySQL服务器配置
MySQL大体有400多项配置参数，大多数参数保持正常配置即可，也有一部分需要根据服务器硬件情况，应用类型、数据量多少以及服务器负载来进行配置。

### 1. MySQL获取配置信息路径
MySQL能从多个方式来获取配置参数，并按照获取的先后顺序来处理相同配置项的参数，后面获取的参数会覆盖前面获取的配置参数，例如

- 命令行参数
通过命令来进行配置，例如：mysqld_safe --datadir=/data/sql_data

- 配置文件
通过配置文件设置MySQL的全局配置，这里要注意的是在不同的系统中MySQL获取配置文件的路径可能会不同。
```sql
mysqld --help --verbose | grep -A 1 'Default options'
#该命令用于查看MySQL加载配置文件的先后顺序
```

### 2. MySQL配置参数作用域
MySQL配置参数根据作用域分为全局参数和会话参数，有些参数只能够在启动时进行加载生效，有些参数是能够在会话中动态修改的。

### 全局参数
只能对全局进行配置的参数，例如：
```sql
set global 参数名=参数值;
set @@global.参数名:=参数值; 
## 这俩种方式的修改都是有效的、
```

### 会话参数
能够全局和当前会话进行配置
```sql
set [session] 参数名=参数值
set @@session.参数名:=参数值
## 设置会话参数的方式
```
注1：会话参数在没有值的时候会使用相同参数的全局参数的值作为配置
注2：全局配置参数的更改是对服务器全局有效的，但对于某些全局参数是对新的连接有效，原有的连接不生效。

## 内存配置相关
MySQL对于内存的使用可以分为俩类，一类是无法通过配置参数来改变的，另外一类是通过参数配置的。

### 1. 内存上限问题
这里的内存上限问题指的是如果配置超出操作系统可用内存的上限，比如对进程可用内存配置过大时，当MySQL连接量增长就会产生内存溢出而奔溃。

同时也要注意操作系统位数，因为32位操作系统内存是由上限的，由于MySQL是单进程的，这意味着只能使用3G内存大小。

### 2. 与连接有关的缓冲区
MySQL的一些缓存是会对每个连接单独分配的，所以如果连接数越大占用的内存会越多，这里主要注意以下几个参数：

- sort_buffer_size
排序缓冲区，该参数限定了SQL语句排序时使用的缓冲区大小，MySQL并不是在连接初始化的时候就分配内存，而是在有查询需要做排序操作时才会分配内存缓冲区。

- join_buffer_size
连接缓冲区尺寸，定义了每个线程使用的连接缓冲区大小，如果一个查询关联多张表，就会为每个连接分配一个连接缓冲区，所以每个查询可能会有多个连接缓冲区。

- read_buffer_size
该参数指定当对一个MyISAM表进行全表扫描的时候，所使用的读缓冲区大小，同样的只有在SQL语句是对MyISAM全表扫描的时候才会分配缓冲区大小，这个值一定要是4K的倍数。

- read_rnd_buffer_size
索引缓冲区大小，也是只有查询需要的时候才分配内存。

这4个参数是针对所有MySQL连接的，如果有100个连接，那么分配的内存大小大约是4个参数缓冲区大小之和的100倍

### 3. 系统预留内存
在配置缓冲区时要先确定为操作系统保留多少内存。

保留的内存大小包括原有服务使用的内存大小，同时还要将MySQL服务器中无法通过参数控制的内存大小计算在内。

注1：MySQL服务器建议使用单独的服务器，如果与其他服务一起使用，不可避免会产生相互征用资源的情况。

注2：建议不要在一台服务器上安装多个MySQL实例，因为这也会产生资源和I/O的争用，从而影响MySQL的性能。

### 4. 存储引擎的缓冲池
### Innodb_buffer_pool_size
该参数定义innodb是使用的缓冲池大小，这个参数对innodb引擎的性能影响是非常重要的。

innodb存储引擎不仅缓存索引，同时还缓存数据、哈希索引、插入缓冲、锁以及其他数据内部结构，innodb还是用缓冲池来帮助延迟写入，这样就能合并多个写入操作，然后一起顺序的写入磁盘中。

总之innodb引擎的性能严重依赖于缓冲池，所以必须保证为它分配足够的内容，如果系统只使用innodb存储引擎，大体可以使用下面的公式计算：

总内存 - （每个线程所需要的内存 * 连接数） - 系统保留内存，剩下的内存空间则是innodb缓冲池的大小，而MySQL手册建议缓冲池为服务器内存的75%以上。

缓冲池的大小也是看实际情况的，如果当前innodb表数据量很少，并且在很长的时间内增长都是预计的话，不必将剩下的所有内存分配给innodb缓冲池，因为innodb缓冲池总量如果超过表innodb表的总数量加索引锁占用的空间大小的话，那就没有意义了。

如果数据量是快速增长的话，那么就需要多预留一些空间了，因为在<5.7之前的MySQL版本，缓冲池的大小是需要重启才生效的。

注：如果缓冲池很大的话，关闭则需要更多的时间将缓冲池的脏页刷新到磁盘上面。

### key_buffer_size
该参数配置的缓冲池只是用于MyISAM存储索引文件使用的，MyISAM的数据是依赖于操作系统的缓冲，如果系统中存在很多张表，给操作系统预留的空间还要包括MyISAM表数据的缓存。

```sql
select sum(index_length) from information_schema.tables
	where engine='myisam';
# 查询MyISAM表数据量大小
```

注：即使所有的表都使用innodb存储引擎，仍然需要为key_buffer_size分配一定空间，因为MySQL系统表仍然是使用MyISAM存储引擎。

## I/O配置
I/O相关的配置参数决定了MySQL如何同步缓冲池中的数据到磁盘上，以进行修改数据持久化的保持，这些操作对性能的影响非常大。

如果要保证数据修改后立即写入到磁盘上，这样的操作时很昂贵的。
### 1. Innodb I/O相关配置
Innodb存储引擎通过Redo Log来实现事务的持久新、原子性和一致性。

为了减少提交事务的开销，Innodb使用了预写日志的方式，也就是在事务提交的时候会先写入事务日志中，而不是把每次修改过的数据写入数据文件中。

这是为了提交I/O性能，因为事务的修改使数据和索引文件通常都会映射到表空间的随机位置上。所以刷新数据变更到数据文件会产生大量的随机IO。

而记录日志是顺序I/O，所以相比于刷新文件到数据系统中记录事务的方法要快的多，一旦事务日志记录完毕，那么数据就相当于完成了持久化，即使数据未变更写入到数据文件上，发生down机，也能通过事务日志文件来回复。

- Innodb_log_file_size：控制带个事务日志的大小
- Innodb_log_fies_in_group：控制事务日志文件的个数

事务日志文件总大小 = Innodb_log_files_in_group* Innodb_log_file_size

事务日志是循环使用的，写满一个才会使用另外一个，因此并不会发生多个日志文件能够提高并发性的访问，所以只需要关注单个日志文件大小。

如果业务繁忙，建议日志文件设置较大一些，一般来说事务日志的总大小应该可以记录服务器一个小时左右的事务信息。

事务每次提交并不是立刻写入到事务日志文件中的，而是先写入事务日志的缓冲区，然后再刷新到磁盘中。

- Innodb_log_buffer_size
用于控制日志缓冲区的大小，通常不需要将该值设置的特别大，因为大概1秒左右就会对该缓冲区刷新，一般缓冲区能够保留1-2秒内的事务数据就足够了，这个值在32M-128M左右就可以了。

- Innodb_flush_log_at_trx_commit
该值决定事务的刷新频率，有3个值，分别是0、1、2。
0是每秒进行一次log写入cache，并flush log到磁盘，但是在事务提交时并不会做任何事情，当然这会在MySQL奔溃时会至少丢失一秒钟的数据；

1是默认值，在每次事务提交时执行log数据写入cache，并flush log到磁盘，虽然安全性高，但是性能最低；

2是建议的值，每次事务提交，执行log数据写入cache，每
秒执行一次flush log到硬盘。

事务刷新到磁盘上要经过俩步，从缓冲区刷新到系统缓存，再由系统缓存刷新到磁盘上，0和2的不同之处在于MySQL进程崩溃，2不会丢失事务，只有整个服务器down机时，才可能丢失至少一秒的事务。

Innodb_flush_method=O_DIRECT
这个参数决定Innodb事务文件、日志文件如何与系统交互，影响innodb写数据和读数据，linux系统建议修改成O_DIRECT，避免linux和MySQL双重缓冲。

Innodb_file_per_table = 1
控制Innodb如何建立表空间，否则会把innodb所有数据存储到系统空间中。
Innodb_doublewrite = 1
双写缓冲，避免页数据没有写完整而导致损坏，innodb的一个页默认大小是16k。

### 2. MyISAM I/O相关参数
delay_key_write
控制关键字缓冲中的脏开什么时候刷新到磁盘上。
OFF：关闭延迟key写入，每次写操作后刷新键缓冲中的脏块到磁盘，安全但应能查
ON：只对在建表时指定了delay_key_write选项的表使用延迟刷新
ALL：对所有MYISAM表都使用延迟键写入

## 安全配置
### expire_logs_days
该参数指定自动清理binlog的天数，以天数为间隔。
如果有开启binlog日志，就应该打开这个选项，让服务器在一定天数后清除就的二进制日志，防止二进制日志占用太多磁盘空间。

### max_allowed_packet
控制MySQL可以接受的包大小，同时也会影响一个用户定义变量的最大容量，5.5的默认值是1M，建议更大一些，32M起步。

如果使用了主从配置，建议这个参数在主从配置中是一致的，从的配置小于主的配置可能会导致主从失败。

### skip_name_resolve
禁用DNS查找，

如果启用该选项，也就是禁用了DNF的查找，那么在用户授权时只允许特定的ip，特定的ip段或者本机host文件中出现的域名来进行授权。

### sysdate_is_now
确保sysdate()函数返回确定性日期，默认情况下在一条SQL语句中多次调用sysdate()函数可能返回的结果不一致。

### read_only
禁止非super权限的用户写权限，建议在主从服务器中的从服务器启用，该参数对保证主从复制的一致性很有用。

### skip_slave_start
禁用Slave自动恢复，同样也是在从服务器中使用。

### sql_model
设置MySQL所使用的SQL模式，默认的SQL语法是宽松的，比如分组中查询中所使用的非聚合函数的列出现在查询中，这是不规范的。
开启该选项后将执行严格语法检查，启用该选项可能会导致原有应用无法执行，慎重使用。

