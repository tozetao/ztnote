一条更新语句的执行过程。

```sql
create table T(ID int primary key, c int);
update T set c = c + 1 where ID = 2;
```

更新语句同查询语句一样，也是要执行相同的流程的。

首先程序与MySQL服务器进行连接，在执行SQL语句时，分析器会通过词法分析和语法分析知道这是一条更新语句，接着优化器会选择ID这个索引，生成执行计划，最后由执行器找到该条记录进行更新。

与查询语句不通，更新语句还涉及到俩个重要的日志模块。



### redo log

redo log日志用于降低更新操作时的I/O成本。

想象一下每次更新一条记录都是写入磁盘，磁盘需要找到对应的那条记录然后再更新，整个I/O和查询成本很高。

而将更新操作写入到redo log，通过一个类似缓冲区的地方将更新操作收集起来，在空闲的时候一起写入到磁盘，这种操作方式I/O效率要高的多。

这种先写入日志，再写入磁盘的方式被称为Write-Ahead Logging。

- 更新过程

  更新一条日志时，InnoDB引擎会把记录写到redo log里面，并更新内存，这时更新就算完成了。只有在空闲的时候，InnoDB引擎才会把这个操作记录更新到磁盘里面。

- 空间问题
  redo log日志是固定大小的，例如配置一组4个文件，每个文件大小1G，那么可写空间就是4G。MySQL会从第一个文件开始写，写到最后一个文件写完时会重头开始写。

  循环写是通过俩个指针来实现的，write pos指针指向当前写入地址，一边写一边往后移动，如果写到末尾文件会回到0号文件开头；check point指针则指向要擦除的地方，即把日志记录写入到磁盘。

  write pos与check point之间的部分是可以写入的空间，如果write pos碰到check point，那么check point指针会就擦除一部分数据，留出可以写入日志记录的空间。

通过redo log，InnoDB就可以保证数据库发生异常重启，数据也不会丢失。这种能力被称为crash-safe。



### bin log

redo log是InnoDB引擎特有的日志，而bin log日志是MySQL Server层的日志，提供归档功能。

俩个日志的不同之处在于：

- redo log是物理日志，记录的是在某个数据页上做了什么修改；bin log是逻辑日志，记录的是这个语句的原始逻辑，比如给ID=2这一行的c字段加1

- redo log是循环写的，空间固定会用完；binglog是可以追加写入的，一个文件写到一定大小后会切换下一个，并不会覆盖之前的日志





### 两阶段提交

在了解了redo log与bin log后，再来看update语句在执行器与InnoDB存储之间的执行过程。

> update t set c = c + 1 where ID = 4

- 执行器先通过引擎获取到ID=4这条记录

- ID是主键，引擎会通过树搜索这行记录。如果ID=4这行记录的数据页本来在内存中，就直接返回给执行器，否则需要从磁盘中读取到内存，然后再返回。

- 执行器在拿到这行记录后，将c字段的值加1，再通过引擎写入这行新数据。

- 引擎将这行新数据更新到内存中，同时将这行记录写入到redo log日志中，此时这行记录在redo log日志中的状态为prepare，接着引擎会告知执行器redo log日志写入完毕，可以提交事务了。

- 执行器将该语句的执行逻辑写入到bin log日志中

- 执行器通过调用引擎的提交事务接口，将ID=4这行记录的在redo log中的状态改为commit状态

至此记录更新完毕。



俩阶段提交指的是redo log日志记录的俩种状态，它是为了保证数据在redo log和bin log日志文件中是一致性的。

如果redo log日志的记录没有俩种状态，在执行上面那条update语句过程中先写入第一个日志后，第二个日志没写完期间发生了crash（崩溃），会出现俩种情况：

- 先写入redo log，再写入bin log

  当MySQL重启时会根据redo log日志恢复崩溃之前的数据，由于bin log没写完MySQL就崩溃了，所以bin log日志这时候数据库恢复后的数据就与bin log日志的记录不一致了。

  如果使用bin log来恢复数据库，那么恢复的数据会不正确。

- 先写入bin log，再写入redo log

  如果先写入bin log日志后发生崩溃，由于redo log没写，在崩溃恢复之后该事务无效，所以要更新行的记录未修改成功，这就导致bin log与当前库的数据不一致了。

所以不用俩阶段提交，数据库的状态可能会和bin log日志恢复出来的库的状态不一致。





### 相关参数

- innodb_flush_log_at_trx_comit

  该参数建议为1，表示每次事务的redo log都直接持久化到磁盘中，保证MySQL异常重启后数据不丢失。

- sync_binlog

  表示每次事务的bin log都持久化到硬盘，可以保证MySQL异常重启之后数据不丢失。

