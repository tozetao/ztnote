## I/O复用

复用是一种在一个通信频道中传递多个数据的技术。

- 时分复用技术
- 频分复用技术



I/O复用服务器端的进程需要确认收到数据的套接字，并通过收到数据的套接字来接收数据。



### API

```c
#include <sys/select.h>
#include <sys/time.h>

int select(int maxfd, fd_set *readset, fd_set *writeset, fd_set *exceptset, const struct timeval * timeout);
```

该函数成功是返回大于0的值，失败时返回-1，参数说明如下：

- maxfd：监视对象文件描述符数量
- readset：是否存在待读取数据的文件描述符数组指针
- writeset：是否有可传输无阻塞数据的文件描述符数组指针
- exceptset：是否发生异常的文件描述符数组指针
- timeout：为了防止调用select()函数进入无线阻塞状态，传递超时信息



select()函数可以同时将多个文件描述符集中到一起统一监视，监视的事件有：

- 是否存在套接字接收数据
- 无需阻塞传输数据的套接字有哪些
- 哪些套接字发生了异常



超时与文件描述符的变化

- 关于超时

  select()函数只有在监视的文件描述符发生变化时才返回，因此需要设置超时时间，select()超时会返回0。

- 文件描述符发生变化

  是指监视的文件描述符发生了相应的监视事件，例如通过select的第二个参数传递的集合中存在需要读取的文件描述符时，就意为着文件描述符发生变化。

  发生变化时，在fd_set数组中所有为1的位均为0，但是发生变化的文件描述符对应位除外，因此可以认为值为1的位置上的文件描述符发生了变化。

- 文件描述符的监视大小

  文件描述符的监视大小与select()函数的第一个参数有关。

  只需要得到注册在fd_set数组中的文件描述符数量，传递到函数中即可，由于文件描述符是从0起始的，因此需要将最大文件描述符值加1.







### 设置文件描述符

select()函数能够同时监视多个文件描述符，监视文件描述符可以视为监视套接字。

监视套接字首先要将文件描述符集中到一起，集中时需要对文件描述符进行区分，可以通过存有0和1的fd_set位数组来操作，存0表示文件描述符，存1表示该文件描述符是监视对象。

C语言提供了对位数组注册文件描述符和更改文件描述符的宏，分别是：

- FD_ZERO(fd_set *fdset)

  将fdset变量的所有位初始化为0

- FD_SET(int fd, fd_set *fdset)

  在参数fdset指向的变量中注册文件描述符fd的信息

- FD_CLR(int fd, fd_set *fdset)

  在参数fdset指向的变量中清楚文件描述符fd的信息

- FD_ISSET(int fd, fd_set *fdset)

  若参数fdset指向的变量中包含文件描述符fd的信息，则返回true

在这些宏中，文件描述符会当做fd_set数组的索引使用，存储的值非0即1。

