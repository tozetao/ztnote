### 什么是TCP/IP协议族

TCP/IP协议族是一个四层协议系统，自底向上分别是数据链路层、网络层、传输层和应用层。

每一层通过不同的协议来完成不同功能，下层协议隐藏细节为上层协议提供服务。



### 数据链路层

实现网卡接口的驱动程序，以处理数据在物理媒介上的传输。

数据链路层最常见的协议是ARP协议和RARP协议，它们实现了IP地址与机器物理地址（通常是MAC地址）之间的相互转换。



### 网络层

网络层实现数据包的选路和转发。

整个WAN（广域网）是由不同分级的路由器来连接分散的主机或LAN（局域网），网络层隐层了网络拓扑连接的过程，使得在传输层和应用层看来，网络是直连的。



网络层最核心的协议是IP协议，IP协议根据数据包的IP地址来决定如何投递该数据包。如果数据包不能直接发送到目标机器，IP协议会寻找一个合适的下一跳路由器，将数据包交由路由器转发。多次重复该过程直到数据包到达目标机器，或者由于发送失败而被丢弃。



网络层另一个重要的协议是ICMP协议，它是IP协议的补充，主要用于检测网络连接。例如ping程序就是使用ICMP协议来查询网络连接。




### 传输层

传输层为俩台主机上的应用程序提供端对端的通信，与网络层使用的逐跳通信方式不同，传输层只关心通信的起始端和目的端，而不关心数据包的中转过程。

传输层的主要协议有三个：TCP、UDP、STCP。



### 应用层

应用层负责处理应用程序的逻辑。应用层在用户空间实在，它负责处理众多逻辑，比如文件传输、名称查询和网络管理等。

应用层常见协议有：

- ping

  它是应用程序，而不是协议，利用ICMP协议来检测网络连接。

- telnet

  一种远程登陆协议，它能够使我们在本地完成任务

- DNS

大多数应用层程序都是使用TCP或UDP提供的服务。



### 封装

在协议系统中，下层协议通过封装为上层提供服务。

应用程序数据在发送到物理网络之前，将沿着协议栈从上到下传递，每层协议都会在上层协议的数据基础上加上自己的头部信息（有时包括尾部信息），以此实现该层的功能。



应用数据发送的具体过程如下：

- TCP/UDP头部 - 应用程序数据 

  经过TCP封装后的数据成为TCP报文段，TCP头部与应用层数据构成了TCP报文段。

  当发送端向一个TCP连接发送数据时，内核中的TCP模块先把数据从进程复制到该连接对应的TCP内核发送缓冲区中，然后TCP模块调用IP模块的服务传递TCP报文段。

- IP头部 - TCP/UDP头部 - 应用程序数据

  IP数据包也包括头部信息和数据信息，其中数据信息可以是TCP报文段、UDP数据报或者ICMP报文。

- 以太网头部 - IP头部 - TCP/UDP头部 - 应用数据 - 以太网尾部

  经过数据链路层封装的数据成为帧（frame）。

  传输媒介不同，帧的类型也不同。比如以太网传输的就是以太帧，而令牌环网络上传输的就是令牌环帧。

以太网头部由6字节的目的物理地址、6字节的源物理地址和2字节类型字段组成，尾部是由4个字节CRC字段组成。在类型字段与CRC字段之间就是上层协议的数据了。

MTU（Max Transmit Unit）是帧的最大传输单元，即最大能携带多少上层协议的数据，比如IP数据报，通常受网络类型限制，例如以太网帧的MTU是1500字节，所以如果IP数据包超过1500字节则会进行分片传输。

所以帧才是最终在物理网络上传输的字节序列。



### 分用

当帧到达目的主机时，将沿着协议栈自底向上依次传递。各层协议依次处理帧中本层负责的头部数据，以获取所需的信息，并最终将处理后的帧交给目标应用程序。

这个过程就是分用（demultiplexing），分用是依靠头部信息中的类型字段实现的，具体如下：

- 数据链路层处理头部信息

  因为IP、ARP、RARP协议都使用帧来传输数据，所以以太网帧使用2字节的类型字段来标识上层协议。如果值是0x800，则帧的数据部分是IP数据报，以太网驱动程序就将帧交付给IP模块；如果值是0x806，则帧的数据部分为ARP请求或应答报文；如果是0x835，帧的数据部分为RARP请求或应答报文。

- 网络层处理头部信息

  由于ICMP协议、TCP、UDP协议都是使用IP协议，所以IP数据包的头部也有2个字节的协议字段来区分它们。

- 传输层处理头部信息

  在传输层，TCP报文段和UDP报文段则通过其头部中的16位端口号字段来区分上层应用程序。

  比如DNS协议对应的端口号是52，HTTP协议是80。

帧通过上述分用步骤后，最终将封装前的原始数据送到目标服务。

对于顶层应用来说，封装和蜂拥似乎从来没发生过。



### ARP协议

后续学习



### DNS协议

后续学习