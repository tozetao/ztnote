TCP为应用层提供可靠的、面向连接的基于字节流的通信协议。

- 可靠

  TCP协议使用超时重传、数据确认等方式来保证数据包被正确的发送至目的端，因此TCP服务是可靠的。

- 面向连接

  使用TCP协议必须建立连接，并在内核中为连接维持必要的数据结构，比如连接状态、读写缓冲区以及定时器等，而在通信双方结束后必须关闭连接以释放这些内核数据，因此TCP是基于流的。



### 字节流服务

在表现形式上，提现在数据通信时双方是否要执行相同次数的读写。

对于字节流服务来说，当发送端程序连续执行多次写入时，TCP模块会将写入的数据从进程的发送缓冲区复制到TCP发送缓冲区中。当TCP模块开始真正发送数据时，发送缓冲区会将这些数据封装成一个或多个TCP报文段发出，因此TCP模块发送的报文端个数与应用程序执行写入的次数之间时没有固定关系的。

当接收端收到一个或多个TCP报文段，TCP模块会根据报文端的序号其复制到内核读缓冲区中，应用程序可以一次性读取所有数据，也可以分次读取数据，这取决于应用程序的缓冲区大小。因此应用程序的读取次数和接受的TCP报文端之间是没有固定关系的。

综上所述，发送端的写入次数与接收端的读取次数之间是没有对应关系的。



### TCP头部信息

TCP头部信息出现在每个TCP报文段中，头部信息用于指定通信的源端口和目标端口，管理TCP连接等。TCP头部信息最多有60个字节，前20个字节是TCP固定头部信息，后40个字节是TCP选项信息。

头部的固定信息从左数起依次有：

- 16位源端口号

- 16位目标端口号

- 32位序号

  一次TCP通信过程中某一个传输方向上的字节流的每个字节的编号。

  假设A和B进行TCP通信，A发送给B的第一个TCP报文段中，序号值将被系统初始化未一个随机的初始序号值 ISN（inital Sequence Number），在从A到B的通信方向上，后续的TCP报文段中序号值将被系统设置成 ISN 加上该报文段所携带数据的第一个字节在整个字节流中的偏移。

  注：是相对整个字节流中的偏移。

  例如某个TCP报文段传输的是字节流中第1025至2048个字节，那么该报文段的序号值就是 ISN + 1025，对于另一个传输方向（从B到A）的TCP报文段的序号值也是相同的含义。

- 32位确认号

  用作对另一方发送来的TCP报文端的确认，确认号的值是收到的TCP报文端的序号值加1。

  比如A与B进行TCP通信，那么A发出的TCP报文段不仅有序列号，也包含对B端发来的TCP报文端的确认号，反之亦然。

- 4位头部长度

  标识该TCP头部有多少个32bit字，因此4位最大能表示15，所以TCP头部最大时60个字节（15 * 4）。

- 6位保留

- 6位标志位

- 16位窗口大小（window size）

  窗口大小是TCP控制流量的一个手段，这里说的窗口是指接收通告窗口（Receiver Window）。

  即接收方告诉对方本端的TCP接收缓冲区还能容纳多少字节的数据，让对方可以控制发送数据的速度。

- 16位校验和

- 16位紧急指针



标志位具体介绍：

- URG

- ACK

  表示ACK标志是否有效，带有ACK标志的报文段称为确认报文段

- PSH

  表示接收端应用程序应该立即从TCP接收缓冲区中读走程序，为接收后续数据腾出空间。

  如果应用程序不将收到的数据读走，数据将会一直停留在接收缓冲区中。

- RST

  复位报文段，表示要求对方重新建立连接

- SYN

  表示请求建立一个连接，携带SYN标志的报文段称为同步报文段

- FIN

  告知对方本端要断开连接了，携带FIN标志的TCP报文段称为结束报文段。



### TCP头部选项

TCP头部选项有7种：

- kind=2，最大报文段长度

  TCP连接初始化时，通信双方使用该选项来协商最大报文段长度（Max Segment Size）。

  TCP模块通常将MSS设置为1460字节，减去的40字节包括IP固定头部的20字节和TCP固定头部的20字节，这样携带的数据就不会超过MTU。

  对于以太网而言，MSS的值是1460（1500-40）

- kink=3，窗口扩大因子选项

  TCP连接初始化时，通信双方使用该选项来协商接收通告窗口（Receiver Window）的扩大因子。

  在TCP头部中，接收通告窗口的大小是用16位来表示的，这意味着能够接收的最大数据是65535，然后TCP为了提高吞吐率，允许接收的数据大小远不止该数字。

  窗口扩大因子解决了该问题，假设TCP通告窗口大小是N，窗口扩大因子是M，那么TCP报文段的实际接收通告窗口大小是$N * 2^M$，M其实是移位数。





### 连接的建立

假设A端与B端建立连接，TCP报文段交换如下：

- A端向B端发送一个SYN报文段，表示请求建立连接，假设序号初始为x
- B端在收到A端的SYN报文段，会发送一个SYN报文段，表示同意建立连接，假设序号初始为y，同时响应SYN报文段，设置确认号为x+1
- A端收到B端的SYN报文段将会发送一个AKC报文段，确认号的值为y+1

一般将上述过程称为TCP的三次握手。从第三个TCP报文段开始，tcpdump输出的序号值与确认号都是相对于ISN值的偏移量。



### 关闭连接

假设A端与B端将要关闭连接，TCP报文段交换如下：

- A端先发送一个FIN报文段，包含序号与确认号
- B端收到A端的FIN报文段后，会先响应一个确认报文段。接着B端也关闭连接，向A端发送一个FIN报文段，也包含序号与确认号

- A端在收到B端的FIN报文段后会响应一个确认报文段，至此连接相互关闭。

这便是TCP的四次握手。



### 半关闭



### 连接超时



### 数据交互



### TCP状态转移





### TIME_WAIT



### 复位报文段（RST）



### TCP超时重传



### 拥塞控制

待填坑





### 数据包抓取实验

遗留问题

1. tcp抓取报文中，win通告窗口大小与mss最大报文段的大小是如何计算来的。

```c
tcpdump
-i
-X：以16禁止显示报文
-S: 显示序号与确认号的真实值


netstat
-a：查看所有

ps 
```





TCP协议如何正确的通信

TCP是一个没有记录边界的字节流协议，因此通讯双方需要自己制定数据边界，也就是定义应用层协议。

比如HTTP协议使用回车符和换行符作为结束标记，简单邮件传送协议（SMTP）使用ASCII回车符和换行符构成的俩个字节标记记录的结束。

