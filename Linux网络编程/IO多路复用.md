### I/O多路复用

应用程序能够处理多个I/O事件的能力称为I/O多路复用。比如标准输入有数据可读，同时某个socket也有数据可读，应用程序能够同时处理这俩个IO发生的读事件，这就是I/O多路服用。



系统函数select、poll和epoo系统调用都支持IO复用，本质上是进程向内核注册要监视的文件描述符，当内核发现进程要监视的文件描述符，它们其中有一种或多种IO事件继续的，就通知进程去处理。



I/O多路复用的应用场合：

- 如果一个客户端处理多个描述符，必须使用I/O复用。

- 如果一个服务器既要处理监听套接字，又要处理已连接的套接字，一般会使用I/O复用。

- 如果一个服务器既要处理TCP，又要处理UDP，一般需要使用I/O复用。



### select

```c
#include <sys/select.h>
#include <sys/time.h>

int select(int maxfd, fd_set *readset, fd_set *writeset, fd_set *exceptset, const struct timeval *timeout);
```

该函数允许进程指定内核要监视的文件描述符，并等待描述符中的多个事件中的任何一个发生。在这个过程进程会被挂起，只有在一个或多个事件发生，或者触发指定的时间超时后进程才会被唤醒。

- maxfd

  所监视描述符的最大个数，它的值是最大描述符的值加1

- readset

  读描述符集合

- writeset

  写描述符集合

- exceptset

  异常描述符集合

- timeout

  指定内核等待所指定描述符中任何一个事件就绪的时间，即超时时间。

  const限定词用于指针时，可以让指针所指向的内容不被修改。

返回值：如果有就绪描述符则返回其数目，若超时则为0，若出错为-1。



#### 描述符集合

描述符集合的实现被隐藏在fd_set集合中了，fd_set集合可以理解成向量，类似于：

```
a[maxfd - 1], ..., a[1], a[0]
```

向量中每个元素都是二进制数中的0或者1，系统实现了相关宏给程序使用。

FD_ZERO用来将这个向量中的所有元素都设置成0；

FD_SET用来把对应套接字fd的元素，a[fd]设置为1；

FD_CLR用来把对应套接字fd的元素，a[fd]设置为0

FD_ISSET对这个向量进行检测检测，判断对应套接字的元素a[fd]是0还是1。

实际上很多系统都是用整数数组来表示一个描述符集合的，一个32位的整数可以表示32个描述符，例如第一个整型数表示0-31，第二个表示32-63，以此类推。



readset、writeset和exceptset三个参数都会被select()系统调用改变。

select()返回时，结果将指示哪些描述符已就绪，同时它会把未就绪的描述符所对应的位都置为0，因此每次重新调用select()时，需要在描述符集合中重新指定要监视的对象。

注：FD_SETSIZE是fd_set的描述符总数，一般是1024，它定义与<sys/select.h>中。



#### timeval

```c
struct timeval {
    long tv_sec;	//秒
    long tv_usec;	//微秒
}
```

timeout参数的值不同，select函数的表现也不同。

如果当值为NULL时，select()系统调用会一直阻塞，直到有某个描述符的IO事件就绪；

如果设置了tv_sec和tv_usec，可以让select()等待程序指定的时间。在此期间如果有IO事件就绪会返回，如果超时将返回错误。

如果tv_sec和tv_usec都为0，则立刻检查描述符集合并立刻返回。







### I/O事件

I/O事件类型比较多，比如有：

- 监听套接字准备好，新的连接已建立成功。
- 标准输入文件描述符准备好可以读。
- 已连接套接字准备好可以写。
- 如果一个I/O事件等待超过了10秒，发生了超时事件





#### 可读条件

套接字可读指的是：

- 该socket接收缓冲区的字节数大于等于套接字的接收缓冲区低水位标记（lower water market），可以理解为缓冲区中有数据可读。低水位标记由SO_RCVLOWAT选项控制。
- 对方连接的读关闭，即接收到FIN报文段。
- 针对一个监听套接字，有已经完成的连接建立，此时accept函数不会阻塞，直接返回已经完成的连接。
- 有一个socket错误待处理，对这样的socket将返回-1，同时把errno设置为确切的错误条件。

总结：当内核通知套接字有数据可读时，使用read函数不会阻塞。



#### 可写条件

套接字可写指的是：

- 该套接字发送缓冲区中的可用空间字节数大于等于套接字的发送缓冲区低水位标记的大小，该套接字可连接（TCP）或不需要连接（UDP），这时候进行wirte操作不会被阻塞。
- 连接的写半边已经关闭，如果继续进行写操作将会产生SIGPIPE信号。
- 套接字错误待处理，对这样的套接字写操作将不阻塞并返回-1，同时把errno设置成确切的错误条件。
- 使用非阻塞式connect的套接字已建立连接，或者connect已经以失败告终。

总结：当内核通知套接字可写，使用write函数不会阻塞。



接收低水位标记与写入低水位标记的目的在于：允许应用进程指定内核，当至少有多少数据可读或者有多大空间可写的时候才算满足I/O就绪。

举例来说，如果我们知道至少存在64个字节的数据，否则我们的应用进程没有任何工作可做，这种情况我们就可用把低水位标记设置为64，以防止少于64个字节的数据准备好读时select唤醒我们。


