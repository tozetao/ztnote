### 什么是TCP/IP协议族

TCP/IP协议族是一个四层协议系统，自底向上分别是数据链路层、网络层、传输层和应用层。每一层通过不同的协议来完成不同功能，下层协议隐藏细节为上层协议提供服务。





### 数据链路层

实现网卡接口的驱动程序，以处理数据在物理媒介上的传输。

数据链路层最常见的协议是ARP协议和RARP协议，它们实现了IP地址与机器物理地址（通常是MAC地址）之间的相互转换。



### 网络层

网络层实现数据包的选路和转发。

整个WAN（广域网）是由不同分级的路由器来连接分散的主机或LAN（局域网），网络层隐层了网络拓扑连接的过程，使得在传输层和应用层看来，网络是直连的。



网络层最核心的协议是IP协议，IP协议根据数据包的IP地址来决定如何投递该数据包。如果数据包不能直接发送到目标机器，IP协议会寻找一个合适的下一跳路由器，将数据包交由路由器转发。多次重复该过程直到数据包到达目标机器，或者由于发送失败而被丢弃。



网络层另一个重要的协议是ICMP协议，它是IP协议的补充，主要用于检测网络连接。例如ping程序就是使用ICMP协议来查询网络连接。




### 传输层

传输层为俩台主机上的应用程序提供端对端的通信，与网络层使用的逐跳通信方式不同，传输层只关心通信的起始端和目的端，而不关心数据包的中转过程。

传输层的主要协议有三个：TCP、UDP、STCP。



### 应用层

应用层负责处理应用程序的逻辑。应用层在用户空间实在，它负责处理众多逻辑，比如文件传输、名称查询和网络管理等。

应用层常见协议有：

- ping

  它是应用程序，而不是协议，利用ICMP协议来检测网络连接。

- telnet

  一种远程登陆协议，它能够使我们在本地完成任务

- DNS

大多数应用层程序都是使用TCP或UDP提供的服务。



### 信息流的发送

在协议系统中，下层协议通过封装为上层提供服务。

应用程序数据在发送到物理网络之前，将沿着协议栈从上到下传递，每层协议都会在上层协议的数据基础上加上自己的头部信息（有时包括尾部信息），以此实现该层的功能。



发送应用数据的具体过程如下：

- 传输层

  传输层接收到应用层数据后，会根据应用层指定的传输层协议来封装协议数据单元（protocol data unit），简称PDU。

  使用TCP协议封装的协议数据单元称为TCP报文段，它由TCP头部信息和应用层数据构成。而由UDP协议封装的协议数据单位称为UDP数据包，它由UDP头部信息和应用层数据构成。

  当发送端向一个TCP连接发送数据时，内核中的TCP模块先把数据从进程复制到该连接对应的TCP内核发送缓冲区中，然后TCP模块调用IP模块的服务传递TCP报文段。

- 网络层

  网络层使用IP协议来封装传输层协议的数据单元，IP协议数据单元称为IP数据报。

  IP数据报由头部信息和数据信息组成，其中数据信息可以是TCP报文段、UDP数据报或者ICMP报文。比如传输层使用TCP协议的话，那么IP数据报由三部分组成：IP头部、TCP、应用程序数据。

- 物理层

  数据链路层封装的数据单元称为帧（frame），它会在IP数据报头部插入以太网头部信息、在尾部附加以太网尾部信息。

  经过数据链路层封装的数据成为帧（frame）。传输媒介不同，帧的类型也不同。比如以太网传输的就是以太帧，而令牌环网络上传输的就是令牌环帧。



以太网头部由6字节的目的物理地址、6字节的源物理地址和2字节类型字段组成，尾部是由4个字节CRC字段组成。在类型字段与CRC字段之间就是上层协议的数据了。

MTU（Max Transmit Unit）是帧的最大传输单元，即最大能携带多少上层协议的数据，比如IP数据报，通常受网络类型限制，例如以太网帧的MTU是1500字节，所以如果IP数据包超过1500字节则会进行分片传输。

所以帧才是最终在物理网络上传输的字节序列。



### 信息流的接收

当帧到达目的主机时，将沿着协议栈自底向上依次传递。各层协议依次处理帧中本层负责的头部数据，以获取所需的信息，并最终将处理后的帧交给目标应用程序。

这个过程就是分用（demultiplexing），分用是依靠头部信息中的类型字段实现的，具体如下：

- 数据链路层处理头部信息

  因为IP、ARP、RARP协议都使用帧来传输数据，所以以太网帧使用2字节的类型字段来标识上层协议。如果值是0x800，则帧的数据部分是IP数据报，以太网驱动程序就将帧交付给IP模块；如果值是0x806，则帧的数据部分为ARP请求或应答报文；如果是0x835，帧的数据部分为RARP请求或应答报文。

- 网络层处理头部信息

  由于ICMP协议、TCP、UDP协议都是使用IP协议，所以IP数据包的头部也有2个字节的协议字段来区分它们。

- 传输层处理头部信息

  在传输层，TCP报文段和UDP报文段则通过其头部中的16位端口号字段来区分上层应用程序。

  比如DNS协议对应的端口号是52，HTTP协议是80。

帧通过上述分用步骤后，最终将封装前的原始数据送到目标服务。







### 协议数据单元

​	网络协议族各层实体交换的单位信息称为协议数据单元（protocol data unit，PDU），所谓的各层实体交换这个动作指的是，发送端层与接收端层之间的动作。比如发送端网络层与接收端网络层的数据交换。

​	除了物理层外，每层的PDU通过由下一层提供给本层的接口，作为服务数据单元（service data unit）传递给下一层，也就是说每一层的PDU是作为下一层PDU的SDU字段，可以理解为是作为下一层的内容段。

​	如果本层的PDU超过下一层的最大SDU限制，那么本层会把PDU划分为若干个大小合适的片段传递给下一层发送，而在对端网络再把这些片段组成PDU。

​	总结：网络协议中每一层协议数据单元由本层协议的头部信息和上一层的协议数据单元组成，可以认为上一层的协议数据单元是作为本层协议数据单元的内容字段。



### 网络协议层的通信

​	PDU的种类很多。

​	应用层交换的PDU称为应用数据，其中在TCP应用进程交换的是没有长度限制的单个双向字节流，在UDP应用进程交换的是其长度不超过UDP发送缓冲区大小的单个记录。



​	传输层交换的PDU称为消息，TCP的PDU称为分节（TCP报文段），消息和分节的长度是有限的。发送端TCP把来自应用进程的字节流数据按照顺序分割在各个分节中传递给接收端TCP。

​	其中每个分节所封装的数据既可以是发送端应用进程单次输出的结果，也可能是多次输出的结果，而且每个分节所封装的单次输出结果或多次输出结果可能是完整的，也可能是不完整的。具体取决于连接建立时对端通告的最大分节大小（maximum segment size, MSS）以及外出接口的最大传输单元（maximum transmission unit, MTU）。

​	分节除了用于承载应用数据外，也可以用于建立连接（SYN分节）、终止连接（FIN分节）、中止连接（RST分节）、确认数据接收（ACK分节）、刷送待发数据（PSH分节）和携带紧急数据指针（URG分节）。



​	UDP的PDU称为UDP消息包。在UDP传输层中，发送端UDP把来自应用进程的单个记录整个封装在UDP消息包发送给接收端UDP。



​	网络层交换的PDN称为IP数据报（IP datagram），其长度有限，IPv4数据包的最大长度是65535字节，IPv6数据包的最大长度是65575字节。发送端IP把来自传输层的消息封装在IP数据报中发送。



​	链路层实体间交换的PDU称为帧（frame），其长度取决于具体的接口。

​	IP数据报由IP头部和传输层数据组成，过长的IP数据报无法封装在帧中，需要对IP数据报的SDU进行分片，再把分成的各个片段加上新的IP头部封装到多个帧中。分片操作一般发生在源端或发送途中，重组分片的过程在目标端。

​	TCP协议为了提高效率会尽可能避免分片和重组，TCP根据MSS和MTU限定每个分节的大小。不论是否分片，IP数据包都是作为数据链路层的SDU传入，由链路层封装在帧中的数据称为包，一个包可以是一个完整的IP数据报，也可能是IP数据报中SDU的一个片段。



### 以太网的通信过程

举例来说，web客户端向web服务器发送数据，web客户端使用TCP协议通信，TCP使用IP协议通信，而IP再通过某种形式的数据链路通信，数据流在客户端是从上向下的。当web服务端接收到信息流时，数据流将会从下向上一步步拆分到应用层。

这就是以太网之间的通信过程。



### Unix errno值

只要一个Unix函数发生错误，全局变量errno就会被设置为一个说明该错误的正值，函数发生错误一般返回-1。

errno的所有正数错误值都是常值，具有以E开头的全大写字母名字，通常定义在<sys/errno.>头文件中，值0不表示任何错误。







### ARP协议

后续学习



### DNS协议

后续学习



