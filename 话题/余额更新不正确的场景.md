![code1](D:\study\repositories\ztnote\problems\code1.png)

问题描述：

插入用户充值记录，接着增加用户余额，明明是在同个事务中，但是出现了有充值记录，用户余额未增加的情况。



Jask Hu：

member_wallet 的记录是7号创建的，money 字段是 0。充值操作是今天进行的。上午 9:30 分 xx 秒， 查看这个时刻 binlog 有两条记录一条是 set， 另一条是 update. money 的值在执行充值操作之后仍然是 0，可以用并发导致的诡异问题解释吗，可以有办法重现问题吗 

当前隔离级别是 repeatable read, 不能出现脏读吧，加不加锁 select 都不会幻读吧。

另一个地方的bug是 if("0.00") 更新用户余额, 代码本身不规范吧。所以只能这样根据binlog 事件还原出问题的步骤： 9:29:59，运营登录账号开始编辑用户的会员等级。（此时页面 money 字段的值是 0）9:30:00, 财务开始为用户充值，充值成功，money 字段被修改为 93.8 元。运营保存编辑内容, 将余额修改为 0了。所以 一定要 select for update 余额查询加锁。数值类型的值，后台接收后一定要转成正确的类型后再使用 --





解决：

昨天的问题解决了，是另一个操作(充值完后，编辑用户等级时)误修改了用户余额。

![cod2](D:\study\repositories\ztnote\problems\cod2.png)

下次我可记得加for update

嗯，框架都有这个链式的，使用的 thinkphp5, ->lock(true) 就可以了。以前，每次写这个锁，都要花一秒质疑一下，为什么要加锁啊，以后再写，就会记得，大佬曾手把手教过我





为什么看不懂源码？

1. 背景知识不够
2. 项目的知识图谱没有构建起来

